<!DOCTYPE html.
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music Routine App v36 - Edit Stats</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style type="text/tailwindcss">
        @layer components {
            .btn-primary { @apply bg-[#E53935] text-white rounded shadow-sm font-medium hover:bg-red-600 transition-colors; }
            .btn-secondary { @apply bg-white text-[#E53935] border border-red-100 rounded shadow-sm font-medium hover:bg-gray-50 transition-colors; }
            .btn-icon { @apply w-8 h-8 rounded-full flex items-center justify-center transition-colors; }
            .card { @apply bg-white rounded-xl shadow-sm border border-gray-100; }
            .sidebar-btn { @apply flex items-center gap-3 font-medium opacity-90 hover:opacity-100 hover:bg-white/10 w-full p-2 rounded text-left text-sm transition-colors; }
            .view-section { @apply hidden h-screen flex-col bg-[#F5F5F5] overflow-y-auto; }
            .view-section.active { @apply flex; }
        }
        :root { --primary-red: #E53935; --bg-light: #F5F5F5; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg-light); overscroll-behavior-y: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        .draggable-item { cursor: grab; }
        .progress-bar-fill { transition: width 0.3s linear; }
    </style>
</head>
<body class="overflow-hidden" onclick="handleWindowClick(event)">

    <div id="image-lightbox" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-2 cursor-zoom-out" onclick="closeImageModal()">
        <img id="lightbox-img" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl transition-transform duration-300 transform scale-95">
        <button class="absolute top-4 right-4 text-white text-4xl opacity-80 hover:opacity-100">&times;</button>
    </div>

    <div id="stat-input-modal" class="fixed inset-0 bg-black/50 z-[90] hidden flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl p-6 text-center transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="stat-modal-title">Record Stat</h3>
            <p class="text-gray-500 text-sm mb-4">Enter your result for today:</p>
            <input type="number" id="stat-input-value" class="text-4xl font-bold text-center w-32 border-b-2 border-[#E53935] outline-none text-[#E53935] mb-6 bg-transparent" placeholder="0" autofocus>
            <div class="flex gap-3 justify-center">
                <button onclick="skipStatInput()" class="px-4 py-2 text-gray-400 font-medium hover:text-gray-600">Skip</button>
                <button onclick="submitStatInput()" class="bg-[#E53935] text-white px-8 py-2 rounded shadow-lg font-bold hover:bg-red-600 transition-transform active:scale-95">Save</button>
            </div>
        </div>
    </div>

    <div id="edit-stats-modal" class="fixed inset-0 bg-black/50 z-[95] hidden flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[80vh] transform transition-all scale-100">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-xl">
                <h3 class="font-bold text-gray-800">Edit Data History</h3>
                <button onclick="document.getElementById('edit-stats-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="edit-stats-list" class="overflow-y-auto p-4 space-y-2 flex-1 bg-gray-50/50">
                </div>
            <div class="p-3 border-t border-gray-100 text-center">
                <button onclick="document.getElementById('edit-stats-modal').classList.add('hidden')" class="text-sm text-[#E53935] font-medium">Close</button>
            </div>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar(false)" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"></div>
    
    <div id="sidebar-menu" class="fixed inset-y-0 left-0 w-72 bg-[#E53935] text-white z-50 transform -translate-x-full transition-transform duration-300 flex flex-col shadow-2xl">
        <div class="p-4 pb-2">
             <h2 class="text-xl font-bold mb-4 px-2">My Routines</h2>
            <ul id="routine-list-container" class="space-y-2 mb-4 overflow-y-auto max-h-[40vh]"></ul>
            
            <div class="flex items-center gap-2 mt-2 pt-4 border-t border-white/20">
                 <button onclick="showAddRoutineInput()" class="flex-1 flex items-center justify-center gap-2 font-medium hover:bg-white/10 p-2 rounded text-sm bg-black/10 transition-colors">
                    <i class="fas fa-plus"></i> New
                </button>
                 <button onclick="triggerSmartImport()" class="flex-1 flex items-center justify-center gap-2 font-medium hover:bg-white/10 p-2 rounded text-sm bg-black/10 transition-colors">
                    <i class="fas fa-file-import"></i> Import
                </button>
                <input type="file" id="import-smart-input" class="hidden" accept=".json" onchange="importSmartRoutines(this)">
            </div>
        </div>
        
        <div class="p-4 border-t border-white/20 border-b">
            <button onclick="showArchivedCount()" class="sidebar-btn">
                <i class="fas fa-archive"></i> Archived Exercises
            </button>
        </div>
        
        <div class="p-4 border-b border-white/20">
            <h3 class="text-xs uppercase text-white/60 font-bold mb-3 tracking-wider">Full System Backup</h3>
            <div class="space-y-2">
                <button onclick="exportRoutines()" class="sidebar-btn"><i class="fas fa-save w-5"></i> Backup All (Export)</button>
                <button onclick="triggerFullRestore()" class="sidebar-btn text-red-100 hover:text-white"><i class="fas fa-exclamation-circle w-5"></i> Restore & Overwrite</button>
                <input type="file" id="import-full-input" class="hidden" accept=".json" onchange="restoreAllRoutines(this)">
            </div>
        </div>

        <div class="mt-auto p-4 space-y-6 pb-8">
            <button onclick="openStatsView()" class="sidebar-btn"><i class="fas fa-chart-line w-6"></i> Stats & Progress</button>
            <a href="#" class="sidebar-btn"><i class="fas fa-cog w-6"></i> Settings</a>
        </div>
    </div>

    <div id="dashboard-view" class="view-section active relative">
        <header class="bg-[#E53935] text-white pt-4 pb-6 px-4 rounded-b-3xl shadow-lg z-10 relative">
            <div class="flex justify-between items-center mb-4 relative">
                <button onclick="toggleSidebar(true)" class="p-2 -ml-2 active:bg-white/20 rounded-full transition-colors">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <h1 class="text-lg font-medium absolute left-1/2 -translate-x-1/2 w-2/3 text-center truncate" id="current-routine-title">My routine</h1>
                <div class="w-8"></div>
            </div>

            <div class="flex justify-between items-center px-2">
                <div class="flex flex-col items-center w-1/3">
                    <i class="fas fa-caret-up cursor-pointer p-2 active:text-gray-200" onclick="adjustGlobalBPM(1)"></i>
                    <span class="text-xl font-bold" id="global-bpm-display">120 BPM</span>
                    <i class="fas fa-caret-down cursor-pointer p-2 active:text-gray-200" onclick="adjustGlobalBPM(-1)"></i>
                </div>
                <div class="w-1/3 flex justify-center">
                    <button id="global-play-btn" class="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center border-4 border-white/30 backdrop-blur-sm active:scale-95 transition-transform" onclick="toggleGlobalAudioOnly()">
                        <i class="fas fa-play text-3xl text-white pl-1" id="global-play-icon"></i>
                    </button>
                </div>
                <div class="flex flex-col items-center w-1/3">
                    <span class="text-2xl font-bold">1/4</span>
                </div>
            </div>
            
            <div class="mt-6 text-center relative px-2">
                <p class="text-sm opacity-90 italic">Practice Time <span id="global-practice-timer">0:00</span> / <span id="total-routine-time">0:00</span></p>
                <div class="absolute right-0 bottom-0 flex items-center justify-between w-full mt-2">
                     <label class="flex items-center gap-1 text-xs bg-black/10 px-2 py-1 rounded cursor-pointer hover:bg-black/20 transition-colors">
                        <input type="checkbox" id="autoplay-toggle" onchange="toggleAutoplay(this.checked)" class="accent-white w-3 h-3">
                        <span class="font-medium text-white/90">Autoplay</span>
                    </label>
                    <div class="flex gap-2">
                        <button onclick="finishAndResetRoutine()" class="bg-white text-[#E53935] text-xs px-3 py-1 rounded shadow-sm font-bold hover:bg-white/90 transition-colors">
                            <i class="fas fa-flag-checkered mr-1"></i> FINISH
                        </button>
                        <button onclick="resetRoutine()" class="bg-white/20 text-xs px-2 py-1 rounded hover:bg-white/30 font-medium">RESET</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-4 space-y-4 pb-24" id="exercise-list"></main>

        <button onclick="toggleModal(true)" class="fixed bottom-6 right-6 w-14 h-14 bg-[#E53935] text-white rounded-full shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform z-20">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <div id="details-view" class="view-section">
        <div class="bg-[#E53935] text-white p-4 pt-6 pb-4 shadow-md flex justify-between items-center sticky top-0 z-20">
            <button onclick="closeDetailsView()" class="text-xl p-2 -ml-2"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-lg font-medium">Details</h2>
            <div class="w-8"></div>
        </div>
        <div class="p-4 space-y-4 pb-10">
            <div class="card p-6">
                <input type="text" id="detail-title-input" class="text-2xl text-gray-800 mb-1 font-normal w-full bg-transparent border-b border-transparent focus:border-[#E53935] outline-none transition-colors" value="Title" oninput="updateExerciseTitle(this.value)">
                
                <div class="flex items-center gap-2 mb-4 text-sm text-gray-500">
                    <i class="fas fa-chart-bar text-[#E53935] opacity-70"></i>
                    <input type="text" id="detail-stat-name-input" class="w-full bg-transparent border-b border-gray-100 focus:border-[#E53935] outline-none text-gray-600 italic placeholder-gray-300" placeholder="Set Stat Name (e.g. BPM)..." oninput="updateDetailStatName(this.value)">
                </div>

                <p class="text-gray-500 mb-6 flex justify-between items-center">
                    <span>Time: <span id="detail-time-display">0:00</span></span>
                    <span id="detail-reps-indicator" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-bold">Rep 1/1</span>
                </p>
                <div class="flex gap-3">
                    <button onclick="resetCurrentDetailExercise()" class="flex-1 py-3 text-[#E53935] border border-red-100 bg-red-50 rounded-lg font-medium shadow-sm active:scale-95 transition-transform">Reset</button>
                    <button id="detail-play-btn" onclick="toggleDetailPlay()" class="flex-1 py-3 text-[#E53935] border border-gray-100 bg-white rounded-lg font-medium shadow-lg shadow-red-50 active:scale-95 transition-transform">Start</button>
                    <button onclick="completeDetailExercise()" class="flex-1 py-3 text-[#E53935] border border-gray-100 bg-white rounded-lg font-medium shadow-sm active:scale-95 transition-transform">Complete</button>
                </div>
            </div>

            <div class="card p-4 space-y-6">
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Repetitions</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustDetailReps(-1)">-</button>
                        <span class="font-medium w-16 text-center" id="detail-reps-display">1</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustDetailReps(1)">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Minutes</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustDetailTime('min', -1)">-</button>
                        <span class="font-medium w-16 text-center" id="detail-min-display">10 min</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustDetailTime('min', 1)">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Seconds</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustDetailTime('sec', -5)">-</button>
                        <span class="font-medium w-16 text-center" id="detail-sec-display">00 sec</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustDetailTime('sec', 5)">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Tempo</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustDetailBPM(-5)">-</button>
                        <span class="font-medium w-16 text-center" id="detail-bpm">120 BPM</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustDetailBPM(5)">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Metronome Auto-Start</span>
                    <input type="checkbox" id="detail-autostart" class="w-5 h-5 accent-[#E53935]" onchange="updateDetailAutoStart(this.checked)">
                </div>
                
                <div class="relative pt-4 border-t border-gray-100">
                     <button id="details-menu-btn" onclick="toggleDetailsMenu(event)" class="flex items-center gap-2 text-gray-500 hover:text-[#E53935]">
                        <i class="fas fa-cog"></i> Advanced Actions
                    </button>
                    <div id="details-menu-dropdown" class="hidden absolute left-0 top-12 bg-white rounded-lg shadow-xl w-48 py-2 z-50 text-gray-700 border border-gray-100">
                        <button onclick="duplicateExercise()" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3"><i class="far fa-copy text-gray-400"></i> Duplicate</button>
                        <button onclick="archiveExercise()" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3"><i class="fas fa-box-archive text-gray-400"></i> Archive</button>
                        <button onclick="deleteDetailExercise()" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 text-red-500"><i class="far fa-trash-alt"></i> Delete</button>
                    </div>
                </div>
            </div>

            <div class="card p-4 pb-8">
                <p class="text-gray-700 font-medium mb-2">Comment</p>
                <textarea id="detail-comment" class="w-full text-sm text-gray-600 border-none outline-none resize-none bg-transparent mb-2" rows="3" placeholder="Add notes (paste URLs here)..." oninput="updateComment(this.value)"></textarea>
                <div id="detail-attachments" class="mt-3 space-y-3">
                    <div id="detail-link-list" class="flex flex-col gap-2"></div>
                    <div id="detail-image-preview" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-view" class="view-section">
        <div class="bg-[#E53935] text-white p-4 pt-6 pb-4 shadow-md flex justify-between items-center sticky top-0 z-20">
            <button onclick="closeStatsView()" class="text-xl p-2 -ml-2"><i class="fas fa-arrow-left"></i></button>
            <h2 class="text-lg font-medium">Professional Stats</h2>
            <div class="w-8"></div>
        </div>

        <div class="p-4 space-y-6 pb-12">
            <div class="grid grid-cols-2 gap-4">
                <div class="card p-4">
                    <div class="text-gray-500 text-xs uppercase font-bold mb-1">Total Practiced</div>
                    <div class="text-2xl font-bold text-[#E53935]" id="stat-total-time">0h 0m</div>
                </div>
                <div class="card p-4">
                    <div class="text-gray-500 text-xs uppercase font-bold mb-1">Streak</div>
                    <div class="text-2xl font-bold text-gray-800"><span id="stat-streak">0</span> <span class="text-sm font-normal text-gray-500">days</span></div>
                </div>
            </div>

            <div class="card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2"><i class="fas fa-chart-line text-[#E53935]"></i> Progress History</h3>
                </div>
                
                <div class="flex flex-wrap gap-2 mb-4 items-end bg-gray-50 p-2 rounded-lg">
                    <label class="flex flex-col text-xs text-gray-500 font-bold">Start: <input type="date" id="stat-filter-start" class="mt-1 border border-gray-200 rounded p-1 text-sm text-gray-700 outline-none focus:border-red-300"></label>
                    <label class="flex flex-col text-xs text-gray-500 font-bold">End: <input type="date" id="stat-filter-end" class="mt-1 border border-gray-200 rounded p-1 text-sm text-gray-700 outline-none focus:border-red-300"></label>
                    <div class="ml-auto flex gap-2 self-end">
                        <button onclick="renderStats()" class="bg-[#E53935] text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-red-600">Filter</button>
                        <button onclick="openEditStatsModal()" class="bg-white text-gray-600 border border-gray-300 px-3 py-1.5 rounded text-sm font-medium hover:bg-gray-50" title="Edit Data"><i class="fas fa-edit"></i> Manage Data</button>
                    </div>
                </div>

                <div class="h-64"><canvas id="progressChart"></canvas></div>
            </div>

            <div class="card p-5">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="far fa-calendar-alt text-[#E53935]"></i> Last 7 Days (By Routine)</h3>
                <div class="h-64"><canvas id="weeklyChart"></canvas></div>
            </div>

            <div class="card p-5">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-chart-pie text-[#E53935]"></i> Focus Distribution</h3>
                <div class="h-48 flex justify-center"><canvas id="routineChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="create-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4 transition-opacity">
        <div class="bg-white w-full max-w-sm rounded-xl shadow-2xl transform transition-all scale-95">
            <div class="p-4 border-b border-gray-100">
                <input type="text" id="new-title" placeholder="Exercise title" class="text-xl w-full outline-none text-gray-700">
                <input type="text" id="new-stat-name" placeholder="Statistic Name (Optional, e.g. BPM, Changes)" class="mt-3 text-sm w-full outline-none text-gray-500 border-b border-gray-200 focus:border-[#E53935] transition-colors pb-1">
            </div>
            <div class="p-6 space-y-6">
                <script>
                    function renderModalRow(label, idBase, fnName, val) {
                        document.write(`
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">${label}</span>
                            <div class="flex items-center gap-3">
                                <button class="btn-icon border border-gray-300 text-gray-500" onclick="${fnName}(-1${idBase.includes('Time')? ",'"+idBase.split('-')[1]+"'" : ''})">-</button>
                                <span class="font-medium w-20 text-center" id="${idBase}-display">${val}</span>
                                <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="${fnName}(1${idBase.includes('Time')? ",'"+idBase.split('-')[1]+"'" : ''})">+</button>
                            </div>
                        </div>`);
                    }
                </script>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Repetitions</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustNewReps(-1)">-</button>
                        <span class="font-medium w-20 text-center" id="new-reps-display">1</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustNewReps(1)">+</button>
                    </div>
                </div>
                 <div class="flex justify-between items-center">
                    <span class="text-gray-700">Tempo</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustNewBPM(-5)">-</button>
                        <span class="font-medium w-20 text-center" id="new-bpm-display">100 BPM</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustNewBPM(5)">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Minutes</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustNewTime('min', -1)">-</button>
                        <span class="font-medium w-20 text-center" id="new-min-display">2 min</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustNewTime('min', 1)">+</button>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Seconds</span>
                    <div class="flex items-center gap-3">
                        <button class="btn-icon border border-gray-300 text-gray-500" onclick="adjustNewTime('sec', -5)">-</button>
                        <span class="font-medium w-20 text-center" id="new-sec-display">00 sec</span>
                        <button class="btn-icon border border-[#E53935] text-[#E53935]" onclick="adjustNewTime('sec', 5)">+</button>
                    </div>
                </div>

                <div class="flex justify-between items-center">
                    <span class="text-gray-700">Metronome Auto-Start</span>
                    <input type="checkbox" id="new-autostart" checked class="w-5 h-5 accent-[#E53935]">
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button onclick="toggleModal(false)" class="px-4 py-2 text-gray-500">Cancel</button>
                    <button onclick="addNewExercise()" class="btn-primary px-6 py-2">create</button>
                </div>
            </div>
        </div>
    </div>
<script>
        // --- DATA & STATE ---
        const initialExercises = [
            { id: 1, title: 'Major Scale', bpm: 80, durationSec: 10, remainingSec: 10, completed: false, autoStart: true, archived: false, reps: 1, currentRep: 1, comment: "Sheet Music: https://jtgt-static.b-cdn.net/images/modules/INT1/IM-113-MajorScale-P1.jpg", statisticName: null, statisticLogs: [] },
            { id: 2, title: 'One Minute Changes', bpm: 120, durationSec: 60, remainingSec: 60, completed: false, autoStart: false, archived: false, reps: 1, currentRep: 1, comment: "G to C changes", statisticName: "Chord Changes", statisticLogs: [] }
        ];

        let state = {
            isExercisePlaying: false, isAudioOn: false, bpm: 120, globalSeconds: 0,
            activeExerciseId: null, exerciseRemaining: 0, viewingExerciseId: null,
            autoplayRoutine: false, 
            pendingDetailCompletion: false,
            routines: [{ id: 'default', name: 'Rutina 1', exercises: JSON.parse(JSON.stringify(initialExercises)) }],
            currentRoutineId: 'default',
            newExerciseForm: { bpm: 100, min: 2, sec: 0, reps: 1 },
            stats: {}
        };

        const STORAGE_KEY = 'musicRoutineApp_v36_stats';

        // --- WEB WORKER SETUP (HILO EN SEGUNDO PLANO) ---
        // Creamos el worker como un Blob para no necesitar archivos externos
        const workerCode = `
            let intervalId;
            self.onmessage = function(e) {
                if (e.data === 'start') {
                    if (!intervalId) {
                        intervalId = setInterval(() => {
                            self.postMessage('tick');
                        }, 1000);
                    }
                } else if (e.data === 'stop') {
                    clearInterval(intervalId);
                    intervalId = null;
                }
            };
        `;
        
        const blob = new Blob([workerCode], { type: "application/javascript" });
        const worker = new Worker(URL.createObjectURL(blob));

        // Esta función recibe el 'tick' del worker cada segundo, sin importar si la pestaña está oculta
        worker.onmessage = function(e) {
            if (e.data === 'tick' && state.isExercisePlaying) {
                // 1. Lógica del tiempo
                state.globalSeconds++;
                recordProgressSeconds(1);

                if (state.activeExerciseId && state.exerciseRemaining > 0) {
                    state.exerciseRemaining--;
                    const ex = getExerciseById(state.activeExerciseId); 
                    if(ex) ex.remainingSec = state.exerciseRemaining;
                    
                    if (state.exerciseRemaining <= 0) {
                        handleExerciseCompletion();
                    }
                }

                // 2. Actualizar UI
                requestAnimationFrame(() => {
                    document.getElementById('global-practice-timer').innerText = formatTime(state.globalSeconds);
                    if (state.activeExerciseId) {
                        renderExercises(); 
                        if(state.viewingExerciseId === state.activeExerciseId) {
                            document.getElementById('detail-time-display').innerText = formatTime(state.exerciseRemaining);
                        }
                    }
                });
            }
        };

        // --- TONE.JS SETUP (SOLO AUDIO) ---
        let metroSynth, bellSynth;
        let beat = 0;

        async function initAudio() {
            await Tone.start();
            
            if (!metroSynth) {
                metroSynth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
                }).toDestination();

                bellSynth = new Tone.PolySynth(Tone.Synth, {
                    oscillator: { type: "sine" },
                    envelope: { attack: 0.01, decay: 1, sustain: 0, release: 1 }
                }).toDestination();
                
                // El metrónomo musical sigue usando Tone.Transport para precisión de ritmo
                Tone.Transport.scheduleRepeat((time) => {
                    if (state.isAudioOn) {
                        const freq = beat === 0 ? "C6" : "G5";
                        metroSynth.triggerAttackRelease(freq, "32n", time);
                    }
                    beat = (beat + 1) % 4;
                }, "4n");
            }
        }

        function playBellSound() {
            if (!bellSynth) return;
            bellSynth.set({
                oscillator: { type: "sine" },
                envelope: { attack: 0.05, decay: 0.6, sustain: 0.1, release: 0.8 },
                volume: -18,
            });
            bellSynth.triggerAttackRelease(["C5", "E5", "G5"], "2n");
        }

        function startMetronomeAudio() {
            beat = 0;
            Tone.Transport.bpm.value = state.bpm;
            if(Tone.Transport.state !== 'started') Tone.Transport.start();
        }

        function stopMetronomeAudio() {
            Tone.Transport.stop();
            beat = 0;
        }

        // --- APP LOGIC ---
       function saveData() {
            if(state.activeExerciseId) {
                const ex = getExerciseById(state.activeExerciseId);
                if(ex) ex.remainingSec = state.exerciseRemaining;
            }
            // CAMBIO AQUÍ: Agregamos globalSeconds al guardado
            localStorage.setItem(STORAGE_KEY, JSON.stringify({
                routines: state.routines, 
                currentRoutineId: state.currentRoutineId, 
                stats: state.stats,
                globalSeconds: state.globalSeconds // <--- NUEVO
            }));
        }

        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    state.routines = parsed.routines;
                    state.currentRoutineId = parsed.currentRoutineId || 'default';
                    state.stats = parsed.stats || {};
                    
                    // CAMBIO AQUÍ: Recuperamos el tiempo o empezamos en 0 si no existe
                    state.globalSeconds = parsed.globalSeconds || 0; 

                    state.routines.forEach(r => r.exercises.forEach(ex => {
                        if (ex.durationSec === undefined && ex.duration !== undefined) { ex.durationSec = ex.duration * 60; delete ex.duration; }
                        if (ex.remainingSec === undefined) ex.remainingSec = ex.durationSec;
                        ex.autoStart = ex.autoStart ?? true; ex.archived = ex.archived ?? false;
                        ex.reps = ex.reps ?? 1; ex.currentRep = ex.currentRep ?? 1; ex.comment = ex.comment ?? "";
                        ex.statisticName = ex.statisticName || null;
                        ex.statisticLogs = ex.statisticLogs || [];
                    }));
                } catch (e) { console.error("Error loading data", e); }
            }
            
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 30);
            document.getElementById('stat-filter-start').value = start.toISOString().split('T')[0];
            document.getElementById('stat-filter-end').value = end.toISOString().split('T')[0];
        }

        function updateExerciseTitle(newTitle) {
            const ex = getExerciseById(state.viewingExerciseId);
            if(ex) { ex.title = newTitle; saveData(); renderExercises(); }
        }

        function updateDetailStatName(newVal) {
            const ex = getExerciseById(state.viewingExerciseId);
            if(ex) { 
                ex.statisticName = newVal.trim() === "" ? null : newVal; 
                saveData(); 
                renderExercises(); 
            }
        }

        function recordProgressSeconds(seconds) {
            const today = new Date().toISOString().split('T')[0];
            if (!state.stats[today]) state.stats[today] = { totalSec: 0, routines: {} };
            state.stats[today].totalSec = Math.max(0, state.stats[today].totalSec + seconds);
            const currentR = getCurrentRoutine();
            if (currentR) {
                if (!state.stats[today].routines[currentR.name]) state.stats[today].routines[currentR.name] = 0;
                state.stats[today].routines[currentR.name] = Math.max(0, state.stats[today].routines[currentR.name] + seconds);
            }
        }

        function getFirstUrl(text) { return (text.match(/(https?:\/\/[^\s]+)/i) || [])[0]; }
        function getFirstImage(text) { return (text.match(/(https?:\/\/[^\s]*\.(?:png|jpg|jpeg|gif|webp|svg)[^\s]*)/i) || [])[0]; }

        function renderCommentAttachments(text) {
            const imgContainer = document.getElementById('detail-image-preview');
            const linkContainer = document.getElementById('detail-link-list');
            imgContainer.innerHTML = ''; linkContainer.innerHTML = '';
            if (!text) return;
            
            const images = text.match(/(https?:\/\/[^\s]*\.(?:png|jpg|jpeg|gif|webp|svg)[^\s]*)/ig) || [];
            images.forEach(url => {
                const img = document.createElement('img');
                img.src = url; img.className = "w-20 h-20 object-cover rounded-lg border border-gray-200 cursor-zoom-in hover:opacity-80 transition shadow-sm bg-gray-50";
                img.onclick = () => openImageModal(url); img.onerror = () => img.style.display = 'none';
                imgContainer.appendChild(img);
            });

            const allLinks = text.match(/(https?:\/\/[^\s]+)/ig) || [];
            allLinks.forEach(url => {
                if(!images.includes(url)) {
                    const btn = document.createElement('a');
                    btn.href = url; btn.target = "_blank";
                    btn.className = "flex items-center gap-2 text-[#E53935] hover:underline bg-red-50 p-2 rounded text-sm w-fit max-w-full truncate";
                    btn.innerHTML = `<i class="fas fa-link"></i> <span class="truncate">${url}</span>`;
                    linkContainer.appendChild(btn);
                }
            });
        }

        function openImageModal(url) {
            const modal = document.getElementById('image-lightbox'), img = document.getElementById('lightbox-img');
            img.src = url; modal.classList.remove('hidden'); setTimeout(() => img.classList.remove('scale-95'), 10);
        }
        function closeImageModal() {
            const modal = document.getElementById('image-lightbox'), img = document.getElementById('lightbox-img');
            img.classList.add('scale-95'); setTimeout(() => modal.classList.add('hidden'), 200);
        }

        window.onload = function() {
        loadData();
        
        // CAMBIO AQUÍ: Guardar todo justo antes de salir o recargar
        window.addEventListener('beforeunload', () => saveData()); 

        new Sortable(document.getElementById('exercise-list'), {
            animation: 150, delay: 300, delayOnTouchOnly: true, handle: '.draggable-item',
            onEnd: function (evt) {
                const routine = getCurrentRoutine();
                routine.exercises.splice(evt.newIndex, 0, routine.exercises.splice(evt.oldIndex, 1)[0]);
                saveData();
            }
        });
        updateUI();
    };

        function finishAndResetRoutine() {
            if(!confirm("Finish routine? This resets exercises.")) return;
            pauseSequence();
            state.activeExerciseId = null; state.exerciseRemaining = 0; state.globalSeconds = 0;
            getCurrentRoutine().exercises.forEach(e => { e.completed = false; e.remainingSec = e.durationSec; e.currentRep = 1; });
            saveData(); updateUI(); alert("Routine Completed!");
        }

        function sanitizeImportedRoutine(r) {
            return {
                id: Date.now() + Math.random().toString(), name: r.name + " (Import)",
                exercises: (r.exercises||[]).map(ex => ({
                    id: Date.now() + Math.floor(Math.random()*100000), title: ex.title||"Untitled", bpm: ex.bpm||100,
                    durationSec: ex.durationSec||60, remainingSec: ex.durationSec||60, completed: false,
                    autoStart: ex.autoStart??true, archived: !!ex.archived, reps: ex.reps||1, currentRep: 1, comment: ex.comment||"",
                    statisticName: ex.statisticName||null, statisticLogs: ex.statisticLogs||[]
                }))
            };
        }
        function triggerSmartImport() { document.getElementById('import-smart-input').click(); }
        function importSmartRoutines(input) {
            if(!input.files[0]) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    const toAdd = (Array.isArray(json) ? json : [json]).map(sanitizeImportedRoutine);
                    state.routines.push(...toAdd); saveData(); renderSidebarRoutines(); toggleSidebar(true); alert(`Imported ${toAdd.length}`);
                } catch(err){ alert("Error: "+err.message); }
            };
            r.readAsText(input.files[0]); input.value='';
        }
        function triggerFullRestore() { document.getElementById('import-full-input').click(); }
        function restoreAllRoutines(input) {
            if(!input.files[0] || !confirm("Overwrite all?")) return;
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    state.routines = json.routines || (Array.isArray(json)?json:[]);
                    state.stats = json.stats || state.stats;
                    state.currentRoutineId = state.routines[0]?.id || 'default';
                    saveData(); resetRoutineLogic(); updateUI(); toggleSidebar(false); alert("Restored!");
                } catch(e){alert("Error");}
            };
            r.readAsText(input.files[0]); input.value='';
        }
        function exportRoutines() { downloadJSON(JSON.stringify({routines:state.routines,stats:state.stats},null,2), `backup_${new Date().toISOString().slice(0,10)}.json`); }
        function exportSingleRoutine(id) {
            const r = state.routines.find(x=>x.id===id); if(r) downloadJSON(JSON.stringify(r,null,2), `routine_${r.name.replace(/\W/g,'_')}.json`);
        }
        function downloadJSON(c,n) { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c],{type:"application/json"})); a.download=n; a.click(); }

        // Audio & Playback
        function toggleGlobalAudioOnly() {
            state.isAudioOn = !state.isAudioOn;
            if (state.isAudioOn) { 
                initAudio().then(startMetronomeAudio); 
            } else { 
                stopMetronomeAudio();
            }
            updateUI();
        }
        function adjustGlobalBPM(val) {
            state.bpm = Math.max(1, Math.min(300, state.bpm + val));
            if(state.activeExerciseId) { const ex = getExerciseById(state.activeExerciseId); if(ex) ex.bpm = state.bpm; }
            Tone.Transport.bpm.value = state.bpm;
            updateUI();
        }
        function toggleListExercise(id) {
            if (state.activeExerciseId === id && state.isExercisePlaying) pauseSequence(); else playExercise(id);
        }
        function playExercise(id) {
            const ex = getExerciseById(id); if (!ex) return;
            if (state.activeExerciseId && state.activeExerciseId !== id) {
                const prev = getExerciseById(state.activeExerciseId); if(prev) prev.remainingSec = state.exerciseRemaining;
            }
            state.activeExerciseId = id;
            state.exerciseRemaining = (ex.remainingSec <= 0) ? ex.durationSec : ex.remainingSec;
            state.bpm = ex.bpm; 
            state.isExercisePlaying = true;
            
            // Iniciamos el worker (reloj del sistema)
            worker.postMessage('start');

            initAudio().then(() => {
                Tone.Transport.bpm.value = state.bpm;
                if (ex.autoStart) { state.isAudioOn = true; startMetronomeAudio(); } 
                else { state.isAudioOn = false; stopMetronomeAudio(); }
            });
            updateUI(); saveData();
        }
        function pauseSequence() {
            if (state.activeExerciseId) { const ex = getExerciseById(state.activeExerciseId); if(ex) ex.remainingSec = state.exerciseRemaining; }
            state.isExercisePlaying = false; 
            state.isAudioOn = false; 
            
            // Detenemos worker y audio
            worker.postMessage('stop');
            stopMetronomeAudio(); 
            
            saveData(); updateUI();
        }
        
        // --- NEW STATISTIC LOGIC ---
        function submitStatInput() {
            const val = parseFloat(document.getElementById('stat-input-value').value);
            if (!isNaN(val)) {
                const ex = getExerciseById(state.activeExerciseId);
                if (ex) {
                    const today = new Date().toISOString().split('T')[0];
                    if(!ex.statisticLogs) ex.statisticLogs = [];
                    ex.statisticLogs.push({ date: today, value: val });
                    saveData();
                }
            }
            closeStatModalAndFinish();
        }

        function skipStatInput() {
            closeStatModalAndFinish();
        }

       function closeStatModalAndFinish() {
            document.getElementById('stat-input-modal').classList.add('hidden');
            
            if (state.pendingDetailCompletion) {
                state.pendingDetailCompletion = false; 
                forceFinishDetail(); 
            } else {
                finalizeCompletion(false); 
            }
        }
        
        function handleExerciseCompletion() {
            // Esta función se llama desde el worker, aseguramos que el contexto de audio esté activo para el sonido
            const ex = getExerciseById(state.activeExerciseId); if (!ex) return;
            
            playBellSound();
            
            if (ex.statisticName && !ex.completed) {
                pauseSequence(); // Esto detiene el worker y el audio
                
                document.getElementById('stat-modal-title').innerText = ex.statisticName;
                document.getElementById('stat-input-value').value = '';
                document.getElementById('stat-input-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('stat-input-value').focus(), 100);
                return; 
            }
            
            finalizeCompletion(false);
        }

        function finalizeCompletion(playSound = true) {
            const ex = getExerciseById(state.activeExerciseId);
            
            if (playSound) playBellSound();
            
            if (ex.currentRep < ex.reps) {
                ex.currentRep++; state.exerciseRemaining = ex.durationSec; ex.remainingSec = ex.durationSec;
                state.isExercisePlaying = true;
                
                // Reiniciar worker para asegurar timing fresco
                worker.postMessage('stop');
                worker.postMessage('start');
                
                if (ex.autoStart) { state.isAudioOn = true; startMetronomeAudio(); }
                updateUI(); saveData();
            } else {
                pauseSequence();
                ex.completed = true; ex.remainingSec = 0; saveData(); updateUI();
                if (state.autoplayRoutine) {
                    const routine = getCurrentRoutine();
                    const activeList = routine.exercises.filter(e => !e.archived);
                    const idx = activeList.findIndex(e => e.id === state.activeExerciseId);
                    if (idx < activeList.length - 1) setTimeout(() => playExercise(activeList[idx+1].id), 1500);
                    else finishAndResetRoutine();
                }
            }
        }

        // --- EDIT STATS LOGIC ---
        function openEditStatsModal() {
            const list = document.getElementById('edit-stats-list');
            list.innerHTML = '';
            
            let allLogs = [];
            state.routines.forEach(r => {
                r.exercises.forEach(e => {
                    if (e.statisticLogs && e.statisticLogs.length > 0) {
                        e.statisticLogs.forEach((log, index) => {
                            allLogs.push({
                                routineId: r.id, exerciseId: e.id, index: index,
                                title: e.title, statName: e.statisticName || "Stat",
                                date: log.date, value: log.value
                            });
                        });
                    }
                });
            });

            allLogs.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (allLogs.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-8">No statistics recorded yet.</div>';
            } else {
                allLogs.forEach(item => {
                    const div = document.createElement('div');
                    div.className = "bg-white p-3 rounded shadow-sm border border-gray-100 flex justify-between items-center";
                    div.innerHTML = `
                        <div>
                            <div class="text-xs text-gray-400 font-bold">${item.date}</div>
                            <div class="font-medium text-gray-700 leading-tight">${item.title}</div>
                            <div class="text-xs text-[#E53935]">${item.statName}: <span class="font-bold text-lg text-gray-800 ml-1">${item.value}</span></div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="editStatValue('${item.routineId}', ${item.exerciseId}, ${item.index})" class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 hover:bg-blue-100 flex items-center justify-center transition-colors"><i class="fas fa-pencil-alt text-xs"></i></button>
                            <button onclick="deleteStatLog('${item.routineId}', ${item.exerciseId}, ${item.index})" class="w-8 h-8 rounded-full bg-red-50 text-red-500 hover:bg-red-100 flex items-center justify-center transition-colors"><i class="fas fa-trash text-xs"></i></button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            document.getElementById('edit-stats-modal').classList.remove('hidden');
        }

        function editStatValue(rId, eId, index) {
            const r = state.routines.find(x => x.id == rId);
            const e = r.exercises.find(x => x.id == eId);
            const log = e.statisticLogs[index];
            
            const newVal = prompt(`Edit value for ${e.title} on ${log.date}:`, log.value);
            if (newVal !== null && newVal.trim() !== "") {
                const num = parseFloat(newVal);
                if (!isNaN(num)) {
                    log.value = num;
                    saveData();
                    openEditStatsModal(); renderStats(); renderExercises();
                } else {
                    alert("Please enter a valid number.");
                }
            }
        }

        function deleteStatLog(rId, eId, index) {
            if(confirm("Are you sure you want to delete this record?")) {
                const r = state.routines.find(x => x.id == rId);
                const e = r.exercises.find(x => x.id == eId);
                e.statisticLogs.splice(index, 1);
                saveData();
                openEditStatsModal(); renderStats(); renderExercises();
            }
        }

        // --- SAFE ROUTINE GETTER (CRASH FIX) ---
        function getCurrentRoutine() {
            let routine = state.routines.find(r => r.id === state.currentRoutineId);
            if (!routine) {
                console.warn("Rutina actual no encontrada, reseteando a la primera disponible.");
                if (state.routines.length > 0) {
                    state.currentRoutineId = state.routines[0].id;
                    routine = state.routines[0];
                } else {
                    routine = { id: 'default-' + Date.now(), name: 'Rutina Recuperada', exercises: [] };
                    state.routines = [routine];
                    state.currentRoutineId = routine.id;
                }
                saveData();
            }
            return routine;
        }
        function getExerciseById(id) { return getCurrentRoutine().exercises.find(e => e.id === id); }
        
        // --- UI RENDERERS ---
        function updateUI() {
            renderExercises();
            document.getElementById('global-practice-timer').innerText = formatTime(state.globalSeconds);
            document.getElementById('global-bpm-display').innerText = `${state.bpm} BPM`;
            document.getElementById('current-routine-title').innerText = getCurrentRoutine().name;
            const icon = document.getElementById('global-play-icon'), btn = document.getElementById('global-play-btn');
            if (state.isAudioOn) { icon.className = "fas fa-pause text-3xl text-white"; btn.classList.add('bg-white/40'); } 
            else { icon.className = "fas fa-play text-3xl text-white pl-1"; btn.classList.remove('bg-white/40'); }
        }

        function renderExercises() {
            const list = document.getElementById('exercise-list'); list.innerHTML = '';
            const currentRoutine = getCurrentRoutine(); if(!currentRoutine) return;
            const visibleExercises = currentRoutine.exercises.filter(e => !e.archived);
            document.getElementById('total-routine-time').innerText = formatTime(visibleExercises.reduce((acc, curr) => acc + (curr.durationSec * curr.reps), 0));

            visibleExercises.forEach(ex => {
                const isActive = ex.id === state.activeExerciseId;
                const isTimerRunning = isActive && state.isExercisePlaying;
                let progressPercent = 0;
                const currentRemaining = isActive ? state.exerciseRemaining : ex.remainingSec;
                let timeText = `${formatTime(currentRemaining)}/${formatTime(ex.durationSec)}`;
                if (ex.completed) { progressPercent = 100; timeText = `${formatTime(ex.durationSec)}/${formatTime(ex.durationSec)}`; } 
                else if(ex.durationSec > 0) { progressPercent = ((ex.durationSec - currentRemaining) / ex.durationSec) * 100; }

                const repsBadge = ex.reps > 1 ? `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded font-bold ml-2">Rep ${ex.currentRep}/${ex.reps}</span>` : '';
                let statBadge = '';
                if (ex.statisticName) {
                    let valText = '';
                    if (ex.statisticLogs && ex.statisticLogs.length > 0) {
                        valText = `: <span class="font-bold">${ex.statisticLogs[ex.statisticLogs.length - 1].value}</span>`;
                    }
                    statBadge = `<span class="bg-purple-100 text-purple-800 text-xs px-2 py-0.5 rounded ml-2 border border-purple-200"><i class="fas fa-chart-bar mr-1"></i>${ex.statisticName}${valText}</span>`;
                }
                
                const startBtnClass = isTimerRunning ? "bg-[#E53935] text-white border-none" : "btn-secondary";
                const imgUrl = getFirstImage(ex.comment), anyUrl = getFirstUrl(ex.comment);
                let rightContent = '';
                if(imgUrl) rightContent += `<img src="${imgUrl}" class="w-12 h-12 flex-shrink-0 object-cover rounded border border-gray-200 bg-gray-50 shadow-sm cursor-zoom-in hover:opacity-80 transition ml-2" onclick="event.stopPropagation(); openImageModal('${imgUrl}')" onerror="this.style.display='none'">`;
                if(anyUrl) rightContent += `<button onclick="event.stopPropagation(); window.open('${anyUrl}', '_blank')" class="w-10 h-10 flex-shrink-0 flex items-center justify-center text-gray-400 hover:text-[#E53935] hover:bg-gray-100 rounded-full transition ml-1"><i class="fas fa-external-link-alt"></i></button>`;

                list.innerHTML += `
                    <div class="draggable-item rounded-xl relative overflow-hidden transition-all shadow-sm border border-gray-100 mb-4 ${ex.completed ? 'bg-[#D1FAE5] border-green-200' : isActive ? 'bg-[#E0F2F1] border-green-100 scale-[1.02]' : 'bg-white'}">
                        <div class="absolute inset-0 bg-[rgba(0,200,83,0.2)] z-0 progress-bar-fill" style="width: ${progressPercent}%"></div>
                        <div class="flex items-center justify-between relative z-10 pr-2">
                            <div class="flex items-center gap-4 flex-1 p-4" onclick="${!ex.completed ? `toggleListExercise(${ex.id})` : ''}">
                                <div class="w-16 h-14 rounded-lg flex items-center justify-center font-bold text-lg transition-colors z-20 flex-shrink-0 ${ex.completed ? 'bg-[#10B981] text-white' : startBtnClass}">
                                    ${ex.completed ? '<i class="fas fa-check"></i>' : isTimerRunning ? 'Stop' : 'Start'}
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-medium text-gray-800 ${ex.completed ? 'text-green-800' : ''} truncate">${ex.title}</h3>
                                    <div class="flex items-center mt-1 flex-wrap gap-y-1">
                                        <p class="text-xs ${isActive ? 'font-bold' : 'text-gray-400'} flex items-center gap-2">
                                            ${timeText} <span class="bg-black/5 px-1.5 rounded font-normal text-gray-500">${ex.bpm} BPM</span> ${!ex.autoStart ? '<i class="fas fa-volume-mute text-xs text-gray-400"></i>' : ''}
                                        </p>
                                        ${repsBadge}
                                        ${statBadge}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center">${rightContent}<div class="py-4 pl-3 pr-4 text-gray-300 hover:text-[#E53935] cursor-pointer" onpointerdown="event.stopPropagation()" onclick="openDetailsView(${ex.id})"><i class="fas fa-chevron-right"></i></div></div>
                        </div>
                    </div>`;
            });
        }

        function formatTime(s) { return `${Math.floor(s/60)}:${(s%60).toString().padStart(2, '0')}`; }
        function openDetailsView(id) {
            state.viewingExerciseId = id; const ex = getExerciseById(id);
            document.getElementById('detail-title-input').value = ex.title;
            document.getElementById('detail-stat-name-input').value = ex.statisticName || "";
            document.getElementById('detail-bpm').innerText = `${ex.bpm} BPM`;
            document.getElementById('detail-min-display').innerText = `${Math.floor(ex.durationSec / 60)} min`;
            document.getElementById('detail-sec-display').innerText = `${(ex.durationSec % 60).toString().padStart(2, '0')} sec`;
            document.getElementById('detail-autostart').checked = ex.autoStart;
            document.getElementById('detail-comment').value = ex.comment || "";
            document.getElementById('detail-reps-display').innerText = ex.reps;
            document.getElementById('detail-reps-indicator').innerText = `Rep ${ex.currentRep}/${ex.reps}`;
            document.getElementById('details-menu-dropdown').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('active');
            document.getElementById('details-view').classList.add('active');
            document.getElementById('detail-time-display').innerText = formatTime((state.activeExerciseId === id) ? state.exerciseRemaining : ex.remainingSec);
            renderCommentAttachments(ex.comment); updateDetailsUI();
        }
        function updateDetailsUI() { const btn = document.getElementById('detail-play-btn'), active = state.activeExerciseId === state.viewingExerciseId && state.isExercisePlaying; btn.innerText = active ? "Pause" : "Start"; btn.className = active ? "btn-primary flex-1 py-3" : "btn-secondary flex-1 py-3"; }
        function toggleDetailPlay() { state.activeExerciseId===state.viewingExerciseId && state.isExercisePlaying ? pauseSequence() : playExercise(state.viewingExerciseId); updateDetailsUI(); }
        function resetRoutine() { resetRoutineLogic(); updateUI(); }
        function resetRoutineLogic() { pauseSequence(); state.activeExerciseId = null; state.exerciseRemaining = 0; state.globalSeconds = 0; getCurrentRoutine().exercises.forEach(e => { e.completed = false; e.remainingSec = e.durationSec; e.currentRep = 1; }); saveData(); updateUI(); }
        function toggleSidebar(s) { document.getElementById('sidebar-menu').classList.toggle('-translate-x-full', !s); document.getElementById('sidebar-overlay').classList.toggle('hidden', !s); renderSidebarRoutines(); }
        function renderSidebarRoutines() { 
            const l=document.getElementById('routine-list-container'); l.innerHTML=''; 
            state.routines.forEach(r=>{ 
                l.innerHTML+=`<li class="flex justify-between items-center p-2 hover:bg-white/10 rounded group"><span onclick="switchRoutine('${r.id}')" class="flex-1 cursor-pointer truncate mr-2 ${r.id===state.currentRoutineId?'font-bold bg-white/20':''}">${r.name}</span><div class="flex items-center gap-3 opacity-80 group-hover:opacity-100 flex-shrink-0"><button onclick="exportSingleRoutine('${r.id}')"><i class="fas fa-file-export text-xs"></i></button><button onclick="renameRoutine('${r.id}')"><i class="fas fa-pencil-alt text-xs"></i></button><button onclick="deleteRoutine('${r.id}')"><i class="fas fa-trash text-xs"></i></button></div></li>`; 
            }); 
        }
        function deleteRoutine(id) { if(state.routines.length<=1)return alert("Cannot delete only routine."); if(confirm("Delete?")){ state.routines.splice(state.routines.findIndex(r=>r.id===id),1); if(state.currentRoutineId===id)switchRoutine(state.routines[0].id); else renderSidebarRoutines(); saveData(); } }
        function renameRoutine(id) { const r=state.routines.find(r=>r.id===id), n=prompt("Rename:", r.name); if(n){ r.name=n; saveData(); renderSidebarRoutines(); if(state.currentRoutineId===id)updateUI(); } }
        function switchRoutine(id) { pauseSequence(); state.currentRoutineId=id; saveData(); toggleSidebar(false); updateUI(); }
        function showAddRoutineInput() { const n=prompt("New Routine Name:"); if(n){ state.routines.push({id:Date.now().toString(),name:n,exercises:[]}); saveData(); renderSidebarRoutines(); } }
        function toggleModal(s) { document.getElementById('create-modal').classList.toggle('hidden',!s); }
        function adjustDetailBPM(v) { const ex=getExerciseById(state.viewingExerciseId); ex.bpm=Math.max(1,ex.bpm+v); document.getElementById('detail-bpm').innerText=`${ex.bpm} BPM`; saveData(); if(state.activeExerciseId===ex.id){state.bpm=ex.bpm; Tone.Transport.bpm.value = ex.bpm; updateUI();} }
        function updateDetailAutoStart(c) { const ex=getExerciseById(state.viewingExerciseId); ex.autoStart=c; saveData(); if(state.activeExerciseId===ex.id && state.isExercisePlaying) { state.isAudioOn = c; c?startMetronomeAudio():stopMetronomeAudio(); updateUI(); } }
        function adjustNewBPM(v) { state.newExerciseForm.bpm+=v; document.getElementById('new-bpm-display').innerText=`${state.newExerciseForm.bpm} BPM`; }
        function adjustNewReps(v) { state.newExerciseForm.reps=Math.max(1,state.newExerciseForm.reps+v); document.getElementById('new-reps-display').innerText=state.newExerciseForm.reps; }
        function adjustNewTime(type,val) { if(type==='min') state.newExerciseForm.min=Math.max(0,state.newExerciseForm.min+val); else state.newExerciseForm.sec=Math.max(0,state.newExerciseForm.sec+val); document.getElementById('new-min-display').innerText=`${state.newExerciseForm.min} min`; document.getElementById('new-sec-display').innerText=`${state.newExerciseForm.sec.toString().padStart(2,'0')} sec`; }
        function addNewExercise() { 
            const titleInput = document.getElementById('new-title');
            const t = titleInput.value; 
            if(!t) { alert("Please enter a title for the exercise."); return; }
            const sNameInput = document.getElementById('new-stat-name');
            const sName = sNameInput.value;
            const total = (state.newExerciseForm.min * 60) + state.newExerciseForm.sec; 
            const newExercise = {
                id: Date.now(), title: t, bpm: state.newExerciseForm.bpm, durationSec: total, remainingSec: total,
                completed: false, autoStart: document.getElementById('new-autostart').checked, archived: false,
                reps: state.newExerciseForm.reps, currentRep: 1, statisticName: sName ? sName : null, statisticLogs: [], comment: ""
            };
            getCurrentRoutine().exercises.push(newExercise); 
            saveData(); titleInput.value = ''; sNameInput.value = ''; 
            toggleModal(false); updateUI(); 
            setTimeout(() => { const list = document.getElementById('exercise-list'); list.scrollTop = list.scrollHeight; }, 50);
        }
        function toggleAutoplay(c) { state.autoplayRoutine=c; }
        function updateComment(v) { const ex=getExerciseById(state.viewingExerciseId); if(ex)ex.comment=v; saveData(); renderCommentAttachments(v); }
        function adjustDetailReps(v) { const ex=getExerciseById(state.viewingExerciseId); if(!ex)return; ex.reps=Math.max(1,ex.reps+v); if(ex.currentRep>ex.reps)ex.currentRep=1; saveData(); document.getElementById('detail-reps-display').innerText=ex.reps; document.getElementById('detail-reps-indicator').innerText=`Rep ${ex.currentRep}/${ex.reps}`; updateUI(); }
        function adjustDetailTime(type,val) { const ex=getExerciseById(state.viewingExerciseId); if(!ex)return; let total=ex.durationSec; if(type==='min') total=Math.max(0,total+(val*60)); else total=Math.max(0,total+val); ex.durationSec=total; ex.remainingSec=total; saveData(); document.getElementById('detail-min-display').innerText=`${Math.floor(total/60)} min`; document.getElementById('detail-sec-display').innerText=`${(total%60).toString().padStart(2,'0')} sec`; }
        function resetCurrentDetailExercise() {
            const id = state.viewingExerciseId, ex = getExerciseById(id);
            if (ex) {
                if (ex.completed) { const d = ex.durationSec; state.globalSeconds = Math.max(0, state.globalSeconds - d); recordProgressSeconds(-d); }
                ex.remainingSec = ex.durationSec; ex.completed = false; ex.currentRep = 1;
                if (state.activeExerciseId === id) { pauseSequence(); state.exerciseRemaining = ex.durationSec; }
                saveData(); updateDetailsUI();
                document.getElementById('detail-time-display').innerText = formatTime(ex.durationSec);
                document.getElementById('global-practice-timer').innerText = formatTime(state.globalSeconds);
            }
        }
        function completeDetailExercise() {
            const ex = getExerciseById(state.viewingExerciseId); if (!ex) return;
            if (ex.statisticName && !ex.completed) {
                state.pendingDetailCompletion = true; state.activeExerciseId = ex.id; 
                if (state.isExercisePlaying) { pauseSequence(); }
                document.getElementById('stat-modal-title').innerText = ex.statisticName;
                document.getElementById('stat-input-value').value = '';
                document.getElementById('stat-input-modal').classList.remove('hidden');
                setTimeout(() => document.getElementById('stat-input-value').focus(), 100);
                return;
            }
            forceFinishDetail();
        }
        function forceFinishDetail() {
            const ex = getExerciseById(state.viewingExerciseId); if (!ex) return;
            let timeToAdd = 0;
            if (state.activeExerciseId === ex.id) {
                timeToAdd = state.exerciseRemaining; pauseSequence();
            } else { timeToAdd = ex.remainingSec; }
            state.globalSeconds += timeToAdd; recordProgressSeconds(timeToAdd);
            ex.completed = true; ex.remainingSec = 0; saveData(); closeDetailsView();
        }
        function toggleDetailsMenu(e) { e.stopPropagation(); document.getElementById('details-menu-dropdown').classList.toggle('hidden'); }
        function handleWindowClick(e) { const m=document.getElementById('details-menu-dropdown'), b=document.getElementById('details-menu-btn'); if(!m.classList.contains('hidden') && !m.contains(e.target) && !b.contains(e.target)) m.classList.add('hidden'); }
        function duplicateExercise() { const o=getExerciseById(state.viewingExerciseId); if(!o)return; const c=JSON.parse(JSON.stringify(o)); c.id=Date.now(); c.title+=" (Copy)"; c.completed=false; c.remainingSec=c.durationSec; c.currentRep=1; const r=getCurrentRoutine(); r.exercises.splice(r.exercises.findIndex(e=>e.id===o.id)+1,0,c); saveData(); closeDetailsView(); }
        function archiveExercise() { const ex=getExerciseById(state.viewingExerciseId); if(ex && confirm("Archive?")){ ex.archived=true; saveData(); closeDetailsView(); } }
        function deleteDetailExercise() { const r=getCurrentRoutine(); if(confirm("Delete?")){ r.exercises.splice(r.exercises.findIndex(e=>e.id===state.viewingExerciseId),1); saveData(); closeDetailsView(); } }
        function showArchivedCount() { alert(`Archived: ${getCurrentRoutine().exercises.filter(e=>e.archived).length}`); }
        function closeDetailsView() { state.viewingExerciseId=null; document.getElementById('details-view').classList.remove('active'); document.getElementById('dashboard-view').classList.add('active'); updateUI(); }

        // --- STATS VIEW ---
        let weeklyChartInstance = null, routineChartInstance = null, progressChartInstance = null;
        function openStatsView() { toggleSidebar(false); document.getElementById('dashboard-view').classList.remove('active'); document.getElementById('details-view').classList.remove('active'); document.getElementById('stats-view').classList.add('active'); renderStats(); }
        function closeStatsView() { document.getElementById('stats-view').classList.remove('active'); document.getElementById('dashboard-view').classList.add('active'); }
        function stringToColor(str) { let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); } return '#' + "00000".substring(0, 6 - (hash & 0x00FFFFFF).toString(16).toUpperCase().length) + (hash & 0x00FFFFFF).toString(16).toUpperCase(); }
        
        function renderStats() {
            const entries = Object.entries(state.stats);
            const totalSecondsAllTime = entries.reduce((acc, [_, data]) => acc + (data.totalSec || 0), 0);
            const dates = Object.keys(state.stats).sort();
            let streak = 0;
            if (dates.length > 0) {
                const todayStr = new Date().toISOString().split('T')[0], yesterdayStr = new Date(Date.now() - 86400000).toISOString().split('T')[0];
                let lastDateStr = new Date(dates[dates.length-1]).toISOString().split('T')[0];
                if (lastDateStr === todayStr || lastDateStr === yesterdayStr) {
                    streak = 1;
                    for (let i = dates.length - 2; i >= 0; i--) {
                        if (Math.ceil(Math.abs(new Date(dates[i+1]) - new Date(dates[i])) / (864e5)) === 1) streak++; else break;
                    }
                }
            }
            document.getElementById('stat-total-time').innerText = `${Math.floor(totalSecondsAllTime / 3600)}h ${Math.floor((totalSecondsAllTime % 3600) / 60)}m`;
            document.getElementById('stat-streak').innerText = streak;

            const last7DaysLabels = [], last7DaysKeys = [];
            for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(d.getDate() - i); last7DaysKeys.push(d.toISOString().split('T')[0]); last7DaysLabels.push(d.toLocaleDateString('en-US', { weekday: 'short' })); }
            const uniqueRoutines = new Set();
            last7DaysKeys.forEach(k => { if (state.stats[k]?.routines) Object.keys(state.stats[k].routines).forEach(r => uniqueRoutines.add(r)); });
            const datasets = Array.from(uniqueRoutines).map(name => ({
                label: name, data: last7DaysKeys.map(k => Math.round((state.stats[k]?.routines?.[name] || 0) / 60)),
                backgroundColor: stringToColor(name), borderRadius: 2
            }));
            if (weeklyChartInstance) weeklyChartInstance.destroy();
            weeklyChartInstance = new Chart(document.getElementById('weeklyChart').getContext('2d'), {
                type: 'bar', data: { labels: last7DaysLabels, datasets },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
            });

            const routineTotals = {}; entries.forEach(([_, d]) => { if (d.routines) Object.entries(d.routines).forEach(([n, s]) => routineTotals[n] = (routineTotals[n] || 0) + s); });
            const rLabels = Object.keys(routineTotals), rData = Object.values(routineTotals).map(s => Math.round(s/60));
            if (routineChartInstance) routineChartInstance.destroy();
            routineChartInstance = new Chart(document.getElementById('routineChart').getContext('2d'), {
                type: 'doughnut', data: { labels: rLabels, datasets: [{ data: rData, backgroundColor: rLabels.map(stringToColor), borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } } }
            });

            let allStats = [];
            state.routines.forEach(r => {
                r.exercises.forEach(e => {
                    if (e.statisticLogs && e.statisticLogs.length > 0) {
                        allStats.push({ name: `${e.title} (${e.statisticName})`, logs: e.statisticLogs });
                    }
                });
            });

            const startVal = document.getElementById('stat-filter-start').value;
            const endVal = document.getElementById('stat-filter-end').value;
            let uniqueDates = new Set();
            allStats.forEach(stat => {
                stat.logs.forEach(log => {
                    if (log.date >= startVal && log.date <= endVal) {
                        uniqueDates.add(log.date);
                    }
                });
            });
            const sortedDates = Array.from(uniqueDates).sort();

            const progressDatasets = allStats.map(stat => {
                const data = sortedDates.map(date => {
                    const entry = stat.logs.find(l => l.date === date);
                    return entry ? entry.value : null;
                });
                if (data.every(v => v === null)) return null;
                return {
                    label: stat.name, data: data,
                    borderColor: stringToColor(stat.name), backgroundColor: stringToColor(stat.name),
                    tension: 0.1, fill: false, spanGaps: true
                };
            }).filter(ds => ds !== null);

            if (progressChartInstance) progressChartInstance.destroy();
            progressChartInstance = new Chart(document.getElementById('progressChart').getContext('2d'), {
                type: 'line', data: { labels: sortedDates, datasets: progressDatasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'bottom', labels: { boxWidth: 10, font: {size: 10} } }, tooltip: { mode: 'index', intersect: false } },
                    scales: { x: { title: { display: true, text: 'Date' } }, y: { title: { display: true, text: 'Value' }, beginAtZero: true } }
                }
            });
        }
    </script>
</body>
</html>